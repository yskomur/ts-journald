# ts-journald

Pure TypeScript systemd-journald client using native Unix sockets. Zero dependencies, high performance logging for Node.js applications on systemd systems.

[![License: MIT](https://img.shields.io/badge/License-MIT-blue.svg)](https://opensource.org/licenses/MIT)
[![Node.js Version](https://img.shields.io/badge/node-%3E%3D14.0.0-brightgreen)](https://nodejs.org/)
[![TypeScript](https://img.shields.io/badge/TypeScript-4.9+-blue)](https://www.typescriptlang.org/)

## Ã–zellikler

- ğŸš€ **Zero Dependencies** - Sadece Node.js core modÃ¼lleri
- âš¡ **High Performance** - Native Unix socket ile direkt journald baÄŸlantÄ±sÄ±
- ğŸ“ **Stack Trace Integration** - Otomatik Ã§aÄŸrÄ± yeri takibi
- ğŸ”§ **Full TypeScript Support** - Tam tip gÃ¼venliÄŸi
- ğŸ”„ **Auto Reconnect** - BaÄŸlantÄ± koparsa otomatik yeniden baÄŸlanma
- ğŸ“Š **All Priority Levels** - EMERG(0)'dan DEBUG(7)'ye tÃ¼m syslog seviyeleri
- ğŸ’¾ **Queue System** - BaÄŸlantÄ± yokken loglarÄ± buffer'da tutar
- ğŸ›¡ï¸ **Fallback Console** - Journald yoksa console'a yazar
- ğŸ” **Field Validation** - Journald format kurallarÄ±na uygun validation

## Kurulum

```bash
npm install ts-journald
# veya
yarn add ts-journald
```

## HÄ±zlÄ± BaÅŸlangÄ±Ã§

### Temel KullanÄ±m

```typescript
import { info, error, warning, debug } from 'ts-journald';

// Otomatik olarak default instance ile log gÃ¶nder
info('Uygulama baÅŸlatÄ±ldÄ±');
error('Bir hata oluÅŸtu', { userId: '12345', action: 'login' });
warning('Disk alanÄ± azalÄ±yor', { freeSpace: '15%' });
debug('Debug mesajÄ±', { timestamp: Date.now() });
```

### Instance OluÅŸturma

```typescript
import { Journal } from 'ts-journald';

const journal = new Journal({
  identifier: 'my-application',
  syslogIdentifier: 'my-node-app',
  captureStackTrace: true,    // Hatalarda stack trace ekler
  fallbackToConsole: true,    // Journald yoksa console'a yazar
  socketPath: '/run/systemd/journal/socket' // VarsayÄ±lan socket yolu
});

journal.info('Service initialized');
```

## API ReferansÄ±

### Priority Seviyeleri

```typescript
import { Priority } from 'ts-journald';

// TÃ¼m priority seviyeleri:
Priority.EMERG      // 0 - Sistem kullanÄ±lamaz
Priority.ALERT      // 1 - Acil eylem gerekiyor
Priority.CRIT       // 2 - Kritik durum
Priority.ERR        // 3 - Hata durumu
Priority.WARNING    // 4 - UyarÄ±
Priority.NOTICE     // 5 - Ã–nemli normal durum
Priority.INFO       // 6 - Bilgilendirme
Priority.DEBUG      // 7 - Debug
```

### Journal SÄ±nÄ±fÄ± MetodlarÄ±

```typescript
const journal = new Journal(options);

// Convenience metodlarÄ±
journal.emergency(message: string, fields?: Record<string, any>): boolean
journal.alert(message: string, fields?: Record<string, any>): boolean
journal.critical(message: string, fields?: Record<string, any>): boolean
journal.error(message: string, fields?: Record<string, any>): boolean
journal.warning(message: string, fields?: Record<string, any>): boolean
journal.notice(message: string, fields?: Record<string, any>): boolean
journal.info(message: string, fields?: Record<string, any>): boolean
journal.debug(message: string, fields?: Record<string, any>): boolean

// Generic log metodu
journal.log(priority: Priority, message: string, fields?: Record<string, any>): boolean

// YardÄ±mcÄ± metodlar
journal.isConnected(): boolean      // Socket baÄŸlantÄ±sÄ±nÄ± kontrol et
journal.close(): void               // BaÄŸlantÄ±yÄ± kapat
journal.addStaticField(name: string, value: string): void  // TÃ¼m loglara eklenen field
journal.removeStaticField(name: string): boolean           // Static field kaldÄ±r
```

### Global Fonksiyonlar

```typescript
import { 
  emergency, alert, critical, error, 
  warning, notice, info, debug, log 
} from 'ts-journald';

// Global instance ile log gÃ¶nder
info('Global log mesajÄ±');
error('Global hata', { code: 'E001' });

// Instance kontrolÃ¼
import { isConnected, close } from 'ts-journald';
console.log('Connected:', isConnected());
close(); // BaÄŸlantÄ±yÄ± kapat
```

## GeliÅŸmiÅŸ KullanÄ±m

### Ã–zel Alanlar (Fields) Ekleme

```typescript
import { Journal } from 'ts-journald';

const journal = new Journal({
  identifier: 'api-server'
});

// TÃ¼m loglara eklenen static field'lar
journal.addStaticField('DEPLOYMENT_ID', process.env.DEPLOYMENT_ID || 'unknown');
journal.addStaticField('REGION', process.env.AWS_REGION || 'local');

// Log mesajÄ± ile Ã¶zel field'lar
journal.info('KullanÄ±cÄ± giriÅŸ yaptÄ±', {
  userId: 'user_123',
  ipAddress: '192.168.1.100',
  userAgent: 'Mozilla/5.0',
  sessionId: 'session_abc'
});

// Field kaldÄ±rma
journal.removeStaticField('REGION');
```

### Stack Trace ile Hata YÃ¶netimi

```typescript
import { Journal } from 'ts-journald';

const journal = new Journal({
  captureStackTrace: true  // Otomatik stack trace (default: true)
});

try {
  // Bir ÅŸeyler yap...
  throw new Error('Test hatasÄ±');
} catch (err) {
  journal.error('Ä°ÅŸlem baÅŸarÄ±sÄ±z oldu', {
    error: err.message,
    errorCode: 'PROCESS_FAILURE',
    // Stack trace otomatik olarak STACK_TRACE field'Ä±na eklenir
  });
}

// Sadece CRIT ve altÄ± iÃ§in stack trace
const journal2 = new Journal({
  captureStackTrace: true,
  // Stack trace sadece ERROR ve daha kritik seviyelerde eklenir
});
```

### Custom Socket Yolu

```typescript
import { Journal } from 'ts-journald';

// FarklÄ± socket yolu kullanma
const journal = new Journal({
  socketPath: '/var/run/systemd/journal/socket', // Ã–zel socket yolu
  fallbackToConsole: false // Console'a fallback yapma
});

// BaÄŸlantÄ± durumunu kontrol et
if (!journal.isConnected()) {
  console.warn('Journald socket baÄŸlantÄ±sÄ± yok');
}
```

### Queue ve BaÄŸlantÄ± YÃ¶netimi

```typescript
import { Journal } from 'ts-journald';

const journal = new Journal();

// Socket baÄŸlantÄ±sÄ± koparsa loglar otomatik olarak queue'lanÄ±r
// BaÄŸlantÄ± geri geldiÄŸinde queue'daki loglar gÃ¶nderilir

// Manuel baÄŸlantÄ± kontrolÃ¼
setInterval(() => {
  console.log('Journal connected:', journal.isConnected());
}, 5000);

// Uygulama kapanÄ±rken
process.on('SIGTERM', () => {
  journal.close();
  process.exit(0);
});
```

## Ã–rnek Uygulama

```typescript
import { Journal } from 'ts-journald';

class DatabaseService {
  private journal: Journal;
  
  constructor() {
    this.journal = new Journal({
      identifier: 'database-service',
      captureStackTrace: true
    });
    
    this.journal.addStaticField('SERVICE', 'database');
    this.journal.addStaticField('NODE_ENV', process.env.NODE_ENV || 'development');
  }
  
  async connect() {
    this.journal.info('Database baÄŸlantÄ±sÄ± baÅŸlatÄ±lÄ±yor', {
      host: process.env.DB_HOST,
      database: process.env.DB_NAME
    });
    
    try {
      // BaÄŸlantÄ± iÅŸlemleri...
      this.journal.info('Database baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±');
    } catch (error) {
      this.journal.critical('Database baÄŸlantÄ± hatasÄ±', {
        error: error.message,
        code: 'DB_CONNECTION_FAILED'
      });
      throw error;
    }
  }
  
  async query(sql: string, params: any[]) {
    this.journal.debug('SQL query Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor', {
      sql: sql.substring(0, 100), // KÄ±saltÄ±lmÄ±ÅŸ SQL
      paramCount: params.length
    });
    
    try {
      // Query Ã§alÄ±ÅŸtÄ±r...
      const result = await db.query(sql, params);
      this.journal.debug('Query baÅŸarÄ±lÄ±', {
        rowCount: result.rowCount
      });
      return result;
    } catch (error) {
      this.journal.error('Query hatasÄ±', {
        sql: sql.substring(0, 200),
        error: error.message,
        errorCode: error.code
      });
      throw error;
    }
  }
}

// Express middleware Ã¶rneÄŸi
import express from 'express';
import { info, error } from 'ts-journald';

const app = express();

app.use((req, res, next) => {
  const start = Date.now();
  
  res.on('finish', () => {
    const duration = Date.now() - start;
    info('HTTP Request', {
      method: req.method,
      path: req.path,
      status: res.statusCode,
      duration: `${duration}ms`,
      ip: req.ip,
      userAgent: req.get('user-agent')
    });
  });
  
  next();
});

app.use((err, req, res, next) => {
  error('Unhandled error', {
    method: req.method,
    path: req.path,
    error: err.message,
    stack: err.stack,
    ip: req.ip
  });
  
  res.status(500).json({ error: 'Internal server error' });
});
```

## Field FormatÄ± ve Limitler

### Journald Field KurallarÄ±

```typescript
// GeÃ§erli field isimleri: harf, rakam, altÃ§izgi
journal.info('Test', {
  USER_ID: '123',       // âœ“ GEÃ‡ERLÄ°
  'REQUEST-ID': 'abc',  // âœ— GEÃ‡ERSÄ°Z (- karakteri)
  'user.email': 'test@example.com' // âœ— GEÃ‡ERSÄ°Z (. karakteri)
});

// Field deÄŸerleri string'e Ã§evrilir
journal.info('Test', {
  count: 42,           // "42" olarak kaydedilir
  active: true,        // "true" olarak kaydedilir
  data: { foo: 'bar' } // "[object Object]" olarak kaydedilir
});
```

### Limitler

- **MESSAGE max size**: 48KB (otomatik truncate edilir)
- **FIELD max size**: 64KB (daha bÃ¼yÃ¼k deÄŸerler gÃ¶nderilmez)
- **Queue size**: SÄ±nÄ±rsÄ±z (uygulama memory'sine baÄŸlÄ±)

## Test ve GeliÅŸtirme

### Development Modu

```typescript
// GeliÅŸtirme ortamÄ±nda console fallback aktif
const devJournal = new Journal({
  fallbackToConsole: process.env.NODE_ENV !== 'production',
  captureStackTrace: process.env.NODE_ENV === 'development'
});
```

### Unit Test

```typescript
// test/journal.test.ts
import { Journal } from 'ts-journald';

describe('Journal', () => {
  let journal: Journal;
  
  beforeEach(() => {
    journal = new Journal({
      fallbackToConsole: false,
      socketPath: '/tmp/test-journal.sock' // Test socket
    });
  });
  
  afterEach(() => {
    journal.close();
  });
  
  it('should create journal instance', () => {
    expect(journal).toBeInstanceOf(Journal);
  });
  
  it('should send info log', () => {
    const result = journal.info('Test message');
    expect(typeof result).toBe('boolean');
  });
});
```

## Sistem Gereksinimleri

- Node.js >= 14.0.0
- Systemd ile Ã§alÄ±ÅŸan Linux daÄŸÄ±tÄ±mÄ±
- Journald socket eriÅŸimi (`/run/systemd/journal/socket`)
- UygulamanÄ±n journald socket'ine yazma izni

## Sorun Giderme

### "Socket connection failed" hatasÄ±

1. **Journald servisini kontrol edin:**
   ```bash
   sudo systemctl status systemd-journald
   ```

2. **Socket dosyasÄ±nÄ± kontrol edin:**
   ```bash
   ls -la /run/systemd/journal/socket
   ```

3. **Socket eriÅŸim izinleri:**
   ```bash
   # Socket grubunu kontrol et
   ls -la /run/systemd/journal/ | grep socket
   
   # KullanÄ±cÄ±yÄ± systemd-journal grubuna ekle
   sudo usermod -a -G systemd-journal $USER
   ```

### Fallback Console KullanÄ±mÄ±

```typescript
// Journald yoksa otomatik console'a yazar
const journal = new Journal({
  fallbackToConsole: true  // Default: true
});

// Sadece baÄŸlantÄ± durumunu logla
journal.info('Test', { _consoleOnly: 'connection test' });
console.log('Is connected:', journal.isConnected());
```

## Performans Ä°puÃ§larÄ±

1. **Static field'larÄ± Ã¶nceden ekleyin:**
   ```typescript
   // KÃ¶tÃ¼: Her logda aynÄ± field'larÄ± eklemek
   journal.info('Message', { app: 'myapp', env: 'prod' });
   journal.error('Error', { app: 'myapp', env: 'prod' });
   
   // Ä°yi: Static field kullanÄ±mÄ±
   journal.addStaticField('APP', 'myapp');
   journal.addStaticField('ENV', 'prod');
   journal.info('Message');
   journal.error('Error');
   ```

2. **Debug loglarÄ±nÄ± production'da kapatÄ±n:**
   ```typescript
   const journal = new Journal();
   
   // Sadece development'ta debug loglarÄ±
   if (process.env.NODE_ENV === 'development') {
     journal.debug('Detailed debug info', { data: largeObject });
   }
   ```

3. **BÃ¼yÃ¼k verileri loglamaktan kaÃ§Ä±nÄ±n:**
   ```typescript
   // KÃ¶tÃ¼: BÃ¼yÃ¼k data loglamak
   journal.info('Data received', { fullData: hugeJSON });
   
   // Ä°yi: Ã–zet bilgi loglamak
   journal.info('Data received', {
     dataSize: hugeJSON.length,
     dataType: typeof hugeJSON,
     hash: createHash(hugeJSON)
   });
   ```

## Lisans

MIT License - Bkz. [LICENSE](LICENSE) dosyasÄ±.

## KatkÄ±da Bulunanlar

Bu proje ÅŸu kaynaklardan ilham almÄ±ÅŸtÄ±r:

- **jourlog** by [yskomur](https://github.com/yskomur) - Go iÃ§in journald logger
- **systemd-journal** - Native systemd socket protokolÃ¼
- **ChatGPT/DeepSeek** - Kod yapÄ±sÄ± ve tasarÄ±m fikirleri

KatkÄ±da bulunmak iÃ§in lÃ¼tfen pull request gÃ¶nderin veya issue aÃ§Ä±n.

---

**Not**: Bu kÃ¼tÃ¼phane sadece systemd journald socket'i olan Linux sistemlerinde Ã§alÄ±ÅŸÄ±r. DiÄŸer sistemlerde fallback console kullanÄ±r veya hata verir.
